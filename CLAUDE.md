# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Packer plugin for [UTM](https://mac.getutm.app/) (macOS virtualization). Provides three builders and two post-processors for creating UTM VM images via HashiCorp Packer. The plugin communicates with UTM through `utmctl` CLI and AppleScript.

## Build & Test Commands

```bash
# Build the plugin binary
make -f GNUmakefile build

# Build dev version and install into Packer
make -f GNUmakefile dev

# Run all tests
make -f GNUmakefile test

# Run a single test
go test -race -count 1 ./builder/utm/common/ -run TestStepShutdown -timeout=3m

# Run acceptance tests (requires UTM installed, PACKER_ACC=1)
make -f GNUmakefile testacc

# Regenerate HCL2 spec files and docs
make -f GNUmakefile generate

# Install packer-sdc tooling
make -f GNUmakefile install-packer-sdc

# Validate plugin compatibility
make -f GNUmakefile plugin-check
```

Go version is pinned in `.go-version` (currently 1.24.1).

## Architecture

### Plugin Registration (main.go)

Registers three builders and two post-processors with the Packer plugin SDK:
- **Builders:** `utm-iso`, `utm-utm`, `utm-cloud`
- **Post-processors:** `utm-zip`, `utm-vagrant`

### Builders

Each builder follows the Packer SDK `multistep` pattern: a `Builder` struct with `Prepare()` (config validation) and `Run()` (step execution) methods.

- **`builder/utm/iso/`** — Builds VMs from ISO files. Creates a new VM, attaches ISO, boots, provisions via SSH, exports. Supports VNC boot commands.
- **`builder/utm/utm/`** — Builds from an existing `.utm` bundle. Imports, provisions, re-exports.
- **`builder/utm/cloud/`** — Builds from QEMU cloud images with cloud-init support. Creates VM, attaches cloud disk, seeds cloud-init config.

### Common Package (`builder/utm/common/`)

Shared step implementations and configuration types used by all builders. Key components:

- **Driver interface** (`driver.go`) — Abstraction over `utmctl` CLI. Version-specific implementations use struct embedding: `Utm45Driver` → `Utm46Driver` → `Utm47Driver`.
- **AppleScript automation** (`scripts/*.applescript`) — Embedded via `//go:embed` for VM operations not available through `utmctl` (creating VMs, attaching drives, configuring displays/networks).
- **Step implementations** — `step_*.go` files implement `multistep.Step` interface: VM creation, port forwarding, SSH, shutdown, export, etc.
- **Config types** — `*_config.go` files define HCL2-compatible configuration blocks (comm, shutdown, export, hardware, etc.).

### Post-Processors

- **`post-processor/vagrant/`** — Packages UTM output into Vagrant boxes.
- **`post-processor/zip/`** — Zips UTM bundle output.

### Code Generation

Files named `*.hcl2spec.go` are auto-generated by `packer-sdc`. Regenerate with `make -f GNUmakefile generate`. Config structs use `//go:generate packer-sdc` directives.

### Version Management

`version/version.go` defines `Version` and `VersionPrerelease`. The goreleaser build overrides these via `-ldflags`. The `dev` make target sets `VersionPrerelease=dev`.

## Key Patterns

- All VM operations go through the `Driver` interface — never call `utmctl` directly from steps.
- State is passed between steps via `multistep.StateBag` with string keys (e.g., `"vmName"`, `"driver"`, `"config"`).
- Build-time QEMU args (VNC, cloud-init) are accumulated in `"buildTimeQemuArgs"` ([]string) in the state bag and cleaned up during export. User-supplied `qemuargs` persist in the exported VM.
- Tests use `driver_mock.go` to avoid requiring a real UTM installation.
- The plugin requires macOS with UTM installed and `utmctl` in PATH for runtime use; tests can run anywhere.
